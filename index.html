<!DOCTYPE html>
<html lang="zh" class="js">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>流量消耗器</title>
  <meta name="keywords" content="IP查询,IP归属查询,在线测速,网速测试,多地IP查询,流量消耗器">
  <meta name="description" content="测试您的网速，多地查询您的IP地址，同时具备网络延迟实时检测">
  <meta http-equiv="Cache-Control" content="no-store" />
  <link rel="stylesheet" href="res/dashlite.css">
  <link rel="stylesheet" href="res/style.css">
  <link rel="shortcut icon" href="images/favicon.ico">
  <link rel="stylesheet" href="res/layer.css" id="layuicss-layer">
  <script src="https://fastly.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
  <style>
    .stat { width:100%; column-gap:1rem; padding:1rem 1.5rem; }
    .stat-title { white-space:nowrap; opacity:.6; }
    .stat-value { white-space:nowrap; grid-column-start:1; font-size:1.8rem; font-weight:700; line-height:2.5rem; }
    .nk-menu-item a { text-decoration:none; }
  </style>
</head>

<body class="nk-body npc-invest bg-lighter no-touch nk-nio-theme" style="cursor:pointer">
<div class="nk-wrap">
  <div class="nk-header nk-header-fluid nk-header-fixed is-light">
    <div class="container-xl">
      <div class="nk-header-wrap link-between">
        <div class="nk-menu-trigger mr-sm-2 d-lg-none">
          <a href="#" class="nk-nav-toggle nk-quick-nav-icon" data-target="headerNav"><em class="icon ni ni-menu"></em></a>
        </div>

        <div class="nk-header-brand">
          <a href="#" class="logo-link text-base"><img src="images/流量.png" class="hide-mb-sm">流量消耗器</a>
        </div>

        <div class="nk-header-tools nk-header-menu" data-content="headerNav">
          <div class="nk-header-mobile">
            <div class="nk-header-brand">
              <a href="/" class="logo-link text-base">
                <span class="nio-version" style="font-size:21px;position:inherit;">流量消耗器</span>
              </a>
            </div>
            <div class="nk-menu-trigger mr-n2">
              <a href="#" class="nk-nav-toggle nk-quick-nav-icon" data-target="headerNav"><em class="icon ni ni-arrow-left"></em></a>
            </div>
          </div>

          <ul class="nk-menu nk-menu-main">
            <li class="nk-menu-item">
              <a href="https://ip.ipgg.cn" class="nk-menu-link nk-ibx-action-item">
                <em class="icon ni ni-map"></em>
                <span class="nk-menu-text">IP归属查询</span>
              </a>
            </li>
            <li class="nk-menu-item">
              <a href="https://v6test.ipgg.cn" class="nk-menu-link nk-ibx-action-item">
                <em class="icon ni ni-network"></em>
                <span class="nk-menu-text">IPV6检测</span>
              </a>
            </li>
            <!-- ✅ 已按你的要求删除“博客”菜单 -->
          </ul>
        </div>

        <div class="no-gutters">
          <ul class="nk-quick-nav">
            <li class="dropdown">
              <a href="javascript:;" class="progress-rating dark-switch ">
                <span class="nk-menu-icon">
                  <em class="icon ni ni-moon"></em>
                  <em class="icon ni ni-sun d-none"></em>
                </span>
              </a>
            </li>
          </ul>
        </div>

      </div>
    </div>
  </div>

  <div class="nk-content nk-content-lg nk-content-fluid">
    <div id="app" class="container-xl">
      <div class="col-sm-12 col-md-10 col-xl-8 center-block">

        <div class="card card-preview">
          <div class="card-inner">
            <div class="nya-title nk-ibx-action-item progress-rating">
              <em class="icon ni ni-info"></em><span class="nk-menu-text font-weight-bold">工具说明</span>
            </div>
            <div class="accordion-inner">
              <div class="title"><span class="dot dot-lg sq" data-bg="#9cabff" style="background:#9cabff;"></span>&nbsp;<span>自定义地址需支持 CORS，否则浏览器会拦截</span></div>
              <div class="title"><span class="dot dot-lg sq" data-bg="#ffa9ce" style="background:#ffa9ce;"></span>&nbsp;<span>速度不满意？请尝试手动切换测速源，加大运行线程</span></div>
              <div class="title"><span class="dot dot-lg sq" data-bg="#f98c45" style="background:#f98c45;"></span>&nbsp;<span>消耗机场流量建议使用海外节点，速度可能更快</span></div>
            </div>
          </div>
        </div>

        <div class="card card-preview">
          <div class="card-inner mt-3">
            <div class="nya-title nk-ibx-action-item progress-rating">
              <em class="icon ni ni-setting"></em><span class="nk-menu-text font-weight-bold">测试设置</span>
            </div>

            <div class="form-group">
              <label class="form-label">测试地址</label>
              <div class="form-control-wrap">
                <select id="select"
                        onchange="document.getElementById('link').value=this.options[this.selectedIndex].value;setCookie('select',this.selectedIndex,365);"
                        class="form-control">

                  <option value="" id="diy">自定义</option>

                  <!-- ✅ 保留朝夕光年游戏 -->
                  <option selected="selected"
                          value="https://lf5-j1gamecdn-cn.dailygn.com/obj/lf-game-lf/gdl_app_2682/1233880772355.mp4">
                    朝夕光年游戏(保留)
                  </option>

                  <!-- ✅ 替换为更稳定、更少踩 CORS 的测速源 -->
                  <optgroup label="稳定测速源（推荐）">
                    <option value="https://speed.cloudflare.com/__down?bytes=25000000">Cloudflare 25MB</option>
                    <option value="https://speed.cloudflare.com/__down?bytes=104857600">Cloudflare 100MB</option>
                    <option value="https://speed.cloudflare.com/__down?bytes=524288000">Cloudflare 500MB</option>
                    <option value="https://speed.cloudflare.com/__down?bytes=1073741824">Cloudflare 1GB</option>

                    <option value="https://cachefly.cachefly.net/100mb.test">Cachefly 100MB</option>
                    <option value="https://cachefly.cachefly.net/200mb.test">Cachefly 200MB</option>
                  </optgroup>

                </select>

                <input value=""
                       oninput="document.getElementById('select').selectedIndex=0;
                                document.getElementById('diy').value=this.value;
                                setCookie('diy',this.value,365);
                                setCookie('select',0,365);"
                       type="text" id="link" placeholder="请输入下载链接(需https且支持CORS)"
                       autocomplete="off" class="form-control">
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">线程</label>
              <div class="form-control-wrap number-spinner-wrap">
                <button onclick="var thread=document.getElementById('thread');if(thread.value!=thread.min)thread.value--;"
                        class="btn btn-icon btn-outline-primary number-spinner-btn number-minus">
                  <em class="icon ni ni-minus"></em>
                </button>

                <input onchange="var self=document.getElementById('thread');
                                 if(self.value<self.min)self.value=self.min;
                                 if(self.value>self.max)self.value=self.max"
                       id="thread" type="number" min="1" max="32" value="1"
                       class="form-control number-spinner">

                <button onclick="var thread=document.getElementById('thread');if(thread.value!=thread.max)thread.value++;"
                        class="btn btn-icon btn-outline-primary number-spinner-btn number-plus">
                  <em class="icon ni ni-plus"></em>
                </button>
              </div>
            </div>

            <div class="form-group" id="back">
              <div class="preview-block">
                <div class="custom-control custom-switch checked">
                  <input onclick="musiccontrol(this)" type="checkbox" id="customSwitch2" class="custom-control-input">
                  <label for="customSwitch2" class="custom-control-label">保持后台运行</label>
                </div>
              </div>
            </div>

            <button onclick="botton_clicked();" type="button" id="do"
                    class="btn btn-dim btn-outline-secondary btn-block card-link">开始</button>

            <div class="row mt-4">
              <div class="col-sm-12 col-md-4 border stat"
                   onclick='inputMax=prompt("请输入流量上限(GB)\\n不填为不设置上限","");if(inputMax !== null)setMax(inputMax)'>
                <div class="text-dark">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="h-15 w-15 float-right pt-3">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z"></path>
                  </svg>
                </div>
                <div class="stat-title">总流量 <a id="showMax"></a></div>
                <div class="stat-value" id="total">-</div>
              </div>

              <div class="col-sm-12 col-md-4 border stat">
                <div class="text-info">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="h-15 w-15 float-right pt-3">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M16.469,8.924l-2.414,2.413c-0.156,0.156-0.408,0.156-0.564,0c-0.156-0.155-0.156-0.408,0-0.563l2.414-2.414c1.175-1.175,1.175-3.087,0-4.262c-0.57-0.569-1.326-0.883-2.132-0.883s-1.562,0.313-2.132,0.883L9.227,6.511c-1.175,1.175-1.175,3.087,0,4.263c0.288,0.288,0.624,0.511,0.997,0.662c0.204,0.083,0.303,0.315,0.22,0.52c-0.171,0.422-0.643,0.17-0.52,0.22c-0.473-0.191-0.898-0.474-1.262-0.838c-1.487-1.485-1.487-3.904,0-5.391l2.414-2.413c0.72-0.72,1.678-1.117,2.696-1.117s1.976,0.396,2.696,1.117C17.955,5.02,17.955,7.438,16.469,8.924"></path>
                  </svg>
                </div>
                <div class="stat-title" id="describe">实时速度</div>
                <div class="stat-value text-info" id="speed">-</div>
              </div>

              <div class="col-sm-12 col-md-4 border stat">
                <div class="text-dark">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="h-15 w-15 float-right pt-3">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                  </svg>
                </div>
                <div class="stat-title">带宽</div>
                <div class="stat-value" id="mbps">-</div>
              </div>
            </div>

          </div>
        </div>

        <div class="card card-preview">
          <div class="card-inner">
            <div class="nya-title nk-ibx-action-item progress-rating">
              <em class="icon ni ni-speed"></em><span class="nk-menu-text font-weight-bold">实时图表</span>
            </div>
            <br>
            <ul class="nk-ecwg8-legends">
              <li><div class="title"><span class="dot" data-bg="#536fc4" style="background:#536fc4;"></span>&nbsp;速 率</div></li>
              <li><div class="title"><span class="dot" data-bg="#90ca74" style="background:#90ca74;"></span>&nbsp;延 迟</div></li>
            </ul>
            <div id="dv" style="position:relative;height:300px;overflow:hidden;"></div>
          </div>
        </div>

        <div class="card card-preview">
          <div class="card-inner">
            <div class="nya-title nk-ibx-action-item progress-rating">
              <em class="icon ni ni-location"></em><span class="nk-menu-text font-weight-bold">出口地址</span>
            </div>
            <div class="accordion-inner">
              <li class="nk-menu-item">
                <a class="text-waring" style="pointer-events:none;">国内 IPv4</a>
                <a class="text-waring" style="pointer-events:none;float:right;" id="ipcn_v4">Loading...</a>
              </li>
              <li class="nk-menu-item">
                <a class="text-waring" style="pointer-events:none;">国内 IPv6</a>
                <a class="text-waring" style="pointer-events:none;float:right;" id="ipcn_v6">Loading...</a>
              </li>
              <li class="nk-menu-item">
                <a style="pointer-events:none;">海外 IPv4</a>
                <a style="pointer-events:none;float:right;" id="ipgb_v4">Loading...</a>
              </li>
              <li class="nk-menu-item">
                <a style="pointer-events:none;">海外 IPv6</a>
                <a style="pointer-events:none;float:right;" id="ipgb_v6">Loading...</a>
              </li>

              <hr>

              <li class="nk-menu-item">
                <a class="text-waring" style="pointer-events:none;">百度连通性</a>
                <a class="text-waring" style="pointer-events:none;float:right;" id="laycn">-ms</a>
              </li>
              <li class="nk-menu-item">
                <a style="pointer-events:none;">Cloudflare连通性</a>
                <a style="pointer-events:none;float:right;" id="laygb">-ms</a>
              </li>
              <li class="nk-menu-item">
                <a class="text-waring" style="pointer-events:none;">Github连通性</a>
                <a class="text-waring" style="pointer-events:none;float:right;" id="github">-ms</a>
              </li>
              <li class="nk-menu-item">
                <a style="pointer-events:none;">Youtube连通性</a>
                <a style="pointer-events:none;float:right;" id="youtube">-ms</a>
              </li>
            </div>
          </div>
        </div>

        <!-- ✅ 项目来源说明（新增） -->
        <div style="
          text-align:center;
          margin:30px 0;
          padding:14px 12px;
          color:#666;
          font-size:13px;
          background:#f7f7f7;
          border-radius:10px;">
          本页面基于开源项目：
          <a href="https://github.com/xinycai/traffic_deplete" target="_blank" style="font-weight:700">
            xinycai / traffic_deplete
          </a>
        </div>

      </div>
    </div>
  </div>
</div>

<audio controls id="music" loop="loop" style="display:none">
  <source src="res/background.mp3" type="audio/mpeg">
</audio>

<script>
  var lastTouchEnd = 0;
  if (!!('ontouchstart' in window || navigator.maxTouchPoints)) {
    document.documentElement.addEventListener('touchend', function (event) {
      var now = Date.now();
      if (now - lastTouchEnd <= 300) event.preventDefault();
      lastTouchEnd = now;
    }, { passive: false });
  }

  function show(num, des, flo) {
    var cnum = num, total_index = 0;
    while (cnum >= 1024) {
      if (total_index == des.length - 1) break;
      cnum = cnum / 1024;
      total_index++;
    }
    return cnum.toFixed(flo[total_index]) + des[total_index];
  }

  function musiccontrol(botton) {
    if (/Mobi|Android|iPhone/i.test(navigator.userAgent)) {
      if (document.getElementById("customSwitch2").checked) document.getElementById("music").play();
      else document.getElementById("music").pause();
    }
  }

  document.getElementById("music").addEventListener("pause", function () {
    document.title = '流量消耗器';
    if (run && !visibl) botton_clicked();
    document.getElementById("customSwitch2").checked = false;
  });

  document.getElementById("music").addEventListener("play", function () {
    if (!(run || visibl)) botton_clicked();
    document.getElementById("customSwitch2").checked = true;
  });

  function setCookie(cname, cvalue, exdays) {
    var d = new Date();
    d.setTime(d.getTime() + (exdays * 24 * 60 * 60 * 1000));
    var expires = "expires=" + d.toGMTString();
    document.cookie = cname + "=" + cvalue + "; " + expires;
  }

  function getCookie(cname) {
    var name = cname + "=";
    var ca = document.cookie.split(';');
    for (var i = 0; i < ca.length; i++) {
      var c = ca[i].trim();
      if (c.indexOf(name) == 0) return c.substring(name.length, c.length);
    }
    return "";
  }

  document.getElementById('diy').value = getCookie("diy");
  if (getCookie("select")) document.getElementById('select').selectedIndex = getCookie("select");
  var selector = document.getElementById("select");
  document.getElementById('link').value = selector.options[selector.selectedIndex].value;

  var Maximum = 0;
  setMax(getCookie('Max'));

  function setMax(inputMax) {
    if (inputMax > 0) {
      setCookie("Max", inputMax, 365);
      Maximum = inputMax * 1073741824;
      document.getElementById("showMax").innerText = '/' + show(Maximum, ['B','KB','MB','GB','TB','PB'], [0,0,1,2,2,2]);
    } else {
      Maximum = 0;
      document.getElementById("showMax").innerText = '';
      setCookie("Max", 0, 365);
    }
  }
</script>

<!-- 原项目的消耗逻辑 -->
<script src="main.js?5"></script>

<script src="js/jquery.min.js"></script>
<script src="js/bootstrap.bundle.min.js"></script>
<script src="js/layer.js"></script>
<script src="js/nioapp.min.js"></script>
<script src="js/script.js"></script>
<script src="js/common.js"></script>

<!-- ✅ IP + 属地/运营商 + 国内/国外（带降级） -->
<script>
  const ipTargets = [
    { id: 'ipcn_v4', url: 'https://v4.ipgg.cn' },
    { id: 'ipcn_v6', url: 'https://v6.ipgg.cn' },
    { id: 'ipgb_v4', url: 'https://v4.wuxie.de' },
    { id: 'ipgb_v6', url: 'https://v6.wuxie.de' }
  ];

  async function fetchText(url) {
    const r = await fetch(url, { cache: 'no-store' });
    if (!r.ok) throw new Error('fetch failed: ' + url);
    return (await r.text()).trim();
  }

  async function lookupGeo(ip) {
    // 归属地 API（若你的网络访问不了，会自动降级只显示 IP）
    const r = await fetch(`https://ipwho.is/${encodeURIComponent(ip)}?lang=zh-CN`, { cache: 'no-store' });
    const j = await r.json();
    if (!j || j.success === false) return null;

    const isp = (j.connection && j.connection.isp) || j.org || '';
    return {
      country: j.country || '',
      region: j.region || '',
      city: j.city || '',
      isp,
      country_code: j.country_code || ''
    };
  }

  function formatLine(ip, geo) {
    if (!geo) return ip; // ✅ 降级：只显示 IP

    const inCN = geo.country_code === 'CN';
    const tag = inCN ? '国内' : '国外';

    let parts = [];
    if (!inCN && geo.country) parts.push(geo.country);
    if (geo.region) parts.push(geo.region);
    if (geo.city) parts.push(geo.city);
    if (geo.isp) parts.push(geo.isp);

    const mid = parts.join('');
    if (mid) return `${ip}*（${mid}） - ${tag}`;
    return `${ip} - ${tag}`;
  }

  ipTargets.forEach(async (t) => {
    const el = document.getElementById(t.id);
    if (!el) return;

    try {
      const ip = await fetchText(t.url);
      try {
        const geo = await lookupGeo(ip);
        el.innerText = formatLine(ip, geo);
      } catch (geoErr) {
        // ✅ 归属地失败不影响页面：只显示 IP
        el.innerText = ip;
        console.warn('Geo lookup failed:', t.id, geoErr);
      }
    } catch (e) {
      el.innerText = 'NULL';
      console.error('IP fetch failed:', t.id, e);
    }
  });
</script>

</body>
</html>
